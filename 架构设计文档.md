# 文件传输工具架构设计文档

## 1. 项目概述

### 1.1 项目简介
这是一个基于C++17开发的高性能文件传输工具，采用客户端-服务器架构，支持安全的大文件传输。项目使用现代C++特性，实现了完整的加密传输、用户认证、权限控制等功能。

### 1.2 核心特性
- **安全传输**: 基于OpenSSL 3.0的AES-256-CBC加密 + Diffie-Hellman密钥交换
- **大文件支持**: 分块传输，支持断点续传
- **用户管理**: 多用户认证系统，4级权限控制
- **高性能**: 异步I/O，连接池，线程池
- **跨平台**: 支持Linux、macOS等POSIX系统

### 1.3 技术栈
- **语言**: C++17
- **构建系统**: CMake 3.15+
- **加密库**: OpenSSL 3.0+
- **压缩库**: ZLIB
- **JSON库**: JSONCPP
- **网络**: POSIX Socket API
- **线程**: std::thread, std::mutex, std::condition_variable

## 2. 整体架构设计

### 2.1 架构模式
项目采用**分层架构**和**模块化设计**，主要分为三层：

```
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)                │
├─────────────────────────────────────────────────────────────┤
│  客户端应用 (client.cpp)    │    服务器应用 (server.cpp)     │
│  用户管理工具 (user_admin)  │                               │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    业务层 (Business Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  客户端核心 (ClientCore)    │    服务器核心 (ServerCore)     │
│  传输处理器 (Handlers)      │    会话管理 (SessionManager)   │
│  认证处理器 (AuthHandler)   │    协议处理器 (ProtocolHandler)│
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    基础设施层 (Infrastructure Layer)         │
├─────────────────────────────────────────────────────────────┤
│  网络通信 (Network)         │    加密工具 (Crypto)          │
│  协议处理 (Protocol)        │    日志系统 (Logging)         │
│  配置管理 (Config)          │    工具类 (Utils)             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 设计原则
1. **单一职责原则**: 每个模块只负责一个特定功能
2. **开闭原则**: 对扩展开放，对修改封闭
3. **依赖倒置**: 高层模块不依赖低层模块，都依赖抽象
4. **接口隔离**: 客户端不应该依赖它不需要的接口
5. **最小知识原则**: 模块间通过接口通信，减少耦合

### 2.3 模块划分

#### 2.3.1 客户端模块 (src/client/)
```
client/
├── core/                    # 核心逻辑
│   ├── client_core.h/cpp    # 客户端核心类，负责连接管理和传输协调
│   └── client_core.h        # 定义传输请求、结果等数据结构
├── handlers/                # 业务处理器
│   ├── upload_handler.h/cpp # 文件上传处理逻辑
│   ├── download_handler.h/cpp # 文件下载处理逻辑
│   └── authentication_handler.h/cpp # 用户认证处理
├── utils/                   # 工具类
│   └── progress_tracker.h/cpp # 传输进度跟踪
└── client.cpp               # 命令行入口程序
```

#### 2.3.2 服务器模块 (src/server/)
```
server/
├── core/                    # 核心逻辑
│   ├── server_core.h/cpp    # 服务器核心类，负责监听和会话管理
│   └── client_session.h/cpp # 客户端会话管理，维护连接状态
├── handlers/                # 业务处理器
│   ├── upload_handler.h/cpp # 服务器端文件上传处理
│   ├── download_handler.h/cpp # 服务器端文件下载处理
│   ├── key_exchange_handler.h/cpp # DH密钥交换处理
│   ├── protocol_handler.h/cpp # 协议消息分发
│   ├── file_lock_manager.h/cpp # 文件锁管理，防止并发冲突
│   └── file_version.h/cpp   # 文件版本管理
├── session/                 # 会话管理
│   └── session_manager.h/cpp # 会话生命周期管理
└── server.cpp               # 命令行入口程序
```

#### 2.3.3 公共模块 (src/common/)
```
common/
├── network/                 # 网络通信
│   ├── socket/
│   │   └── tcp_socket.h/cpp # TCP套接字封装，支持超时和错误处理
│   ├── connection/
│   │   └── connection_pool.h/cpp # 连接池管理
│   └── async/
│       └── event_loop.h/cpp # 事件循环实现
├── protocol/                # 通信协议
│   ├── core/
│   │   └── protocol_header.h/cpp # 协议头定义和处理
│   ├── messages/            # 协议消息
│   │   ├── upload_message.h/cpp # 上传消息格式
│   │   ├── download_message.h/cpp # 下载消息格式
│   │   ├── key_exchange_message.h/cpp # 密钥交换消息
│   │   └── authentication_message.h/cpp # 认证消息
│   └── protocol.h/cpp       # 协议基础定义和消息处理
└── utils/                   # 工具类
    ├── crypto/
    │   └── encryption.h/cpp # OpenSSL 3.0 EVP API封装
    ├── auth/
    │   └── user_manager.h/cpp # 用户管理和认证
    ├── logging/
    │   └── logger.h/cpp     # 日志记录器
    └── config/
        └── config_parser.h/cpp # 配置文件解析器
```

## 3. 核心技术实现

### 3.1 安全机制设计

#### 3.1.1 加密架构
项目采用**混合加密**方案，结合对称加密和非对称加密的优势：

```
客户端                                   服务器
   │                                       │
   │  1. 发起连接                           │
   │───────────────────────────────────────▶│
   │                                       │
   │  2. DH密钥交换                         │
   │◀──────────────────────────────────────▶│
   │                                       │
   │  3. 派生AES密钥                        │
   │◀──────────────────────────────────────▶│
   │                                       │
   │  4. AES加密传输                        │
   │◀──────────────────────────────────────▶│
```

**关键技术点：**
- **Diffie-Hellman密钥交换**: 使用RFC 7919标准的ffdhe2048命名组
- **HKDF密钥派生**: 从DH共享密钥派生AES-256-CBC密钥和IV
- **OpenSSL 3.0 EVP API**: 使用现代API，避免废弃函数警告

#### 3.1.2 用户认证系统
实现完整的用户管理和权限控制系统：

```cpp
// 权限级别定义
enum class Permission : uint8_t {
    READ = 1,      // 下载文件
    WRITE = 2,     // 上传文件  
    DELETE = 4,    // 删除文件
    ADMIN = 8      // 管理权限
};

// 用户信息结构
struct UserInfo {
    std::string username;
    std::string password_hash;  // SHA-256 + 随机盐
    uint8_t permissions;
    bool is_active;
    int failed_login_attempts;
    std::chrono::system_clock::time_point last_login;
};
```

**安全特性：**
- **密码加密**: SHA-256 + 随机盐，防止彩虹表攻击
- **API密钥**: 支持双重认证机制
- **登录限制**: 失败次数限制，防止暴力破解
- **权限隔离**: 基于用户权限的文件访问控制

### 3.2 网络通信设计

#### 3.2.1 协议设计
采用自定义二进制协议，支持消息类型和标志位：

```cpp
struct ProtocolHeader {
    uint32_t magic;           // 魔数，用于协议识别
    uint32_t version;         // 协议版本
    uint32_t message_id;      // 消息ID
    uint32_t payload_length;  // 负载长度
    uint8_t operation_type;   // 操作类型
    uint8_t flags;           // 标志位（加密、压缩等）
    uint16_t reserved;       // 保留字段
};
```

**消息类型：**
- `UPLOAD_REQUEST`: 上传请求
- `UPLOAD_DATA`: 上传数据块
- `DOWNLOAD_REQUEST`: 下载请求
- `DOWNLOAD_DATA`: 下载数据块
- `KEY_EXCHANGE`: 密钥交换
- `AUTHENTICATION`: 用户认证
- `HEARTBEAT`: 心跳包

#### 3.2.2 连接管理
实现连接池和会话管理：

```cpp
class ConnectionPool {
private:
    std::queue<std::unique_ptr<TcpSocket>> available_connections_;
    std::unordered_map<int, std::unique_ptr<TcpSocket>> active_connections_;
    std::mutex pool_mutex_;
    size_t max_connections_;
    
public:
    std::unique_ptr<TcpSocket> acquire_connection();
    void release_connection(std::unique_ptr<TcpSocket> socket);
};
```

### 3.3 文件传输机制

#### 3.3.1 分块传输
支持大文件的分块传输和断点续传：

```cpp
struct TransferRequest {
    std::string local_file;
    std::string remote_file;
    size_t chunk_size;        // 默认1MB
    bool resume;              // 断点续传标志
    size_t offset;            // 传输偏移量
};
```

**传输流程：**
1. **文件分析**: 计算文件大小，检查断点续传
2. **分块传输**: 按chunk_size分块，支持并发传输
3. **进度跟踪**: 实时显示传输进度
4. **完整性校验**: MD5/SHA256校验文件完整性

#### 3.3.2 并发控制
实现文件锁机制，防止并发冲突：

```cpp
class FileLockManager {
private:
    std::unordered_map<std::string, std::shared_mutex> file_locks_;
    std::mutex lock_map_mutex_;
    
public:
    bool acquire_read_lock(const std::string& filename);
    bool acquire_write_lock(const std::string& filename);
    void release_lock(const std::string& filename);
};
```

## 4. 设计模式应用

### 4.1 单例模式 (Singleton)
用于全局资源管理：

```cpp
class UserManager {
private:
    static UserManager* instance_;
    static std::mutex instance_mutex_;
    
public:
    static UserManager& instance() {
        std::lock_guard<std::mutex> lock(instance_mutex_);
        if (!instance_) {
            instance_ = new UserManager();
        }
        return *instance_;
    }
};
```

### 4.2 工厂模式 (Factory)
用于消息对象创建：

```cpp
class MessageFactory {
public:
    static std::unique_ptr<Message> create_message(OperationType type);
    static std::unique_ptr<Message> create_message_from_buffer(const std::vector<uint8_t>& buffer);
};
```

### 4.3 观察者模式 (Observer)
用于进度通知：

```cpp
class ProgressTracker {
public:
    using ProgressCallback = std::function<void(size_t, size_t)>;
    
    void set_progress_callback(ProgressCallback callback);
    void update_progress(size_t current, size_t total);
    
private:
    ProgressCallback callback_;
};
```

### 4.4 策略模式 (Strategy)
用于不同的传输策略：

```cpp
class TransferStrategy {
public:
    virtual bool transfer(const TransferRequest& request) = 0;
    virtual ~TransferStrategy() = default;
};

class UploadStrategy : public TransferStrategy {
public:
    bool transfer(const TransferRequest& request) override;
};

class DownloadStrategy : public TransferStrategy {
public:
    bool transfer(const TransferRequest& request) override;
};
```

## 5. 性能优化策略

### 5.1 内存管理
- **智能指针**: 使用`std::unique_ptr`和`std::shared_ptr`管理资源
- **移动语义**: 利用C++11移动语义减少拷贝开销
- **内存池**: 连接池和对象池减少内存分配开销

### 5.2 并发处理
- **线程池**: 固定大小线程池处理客户端请求
- **异步I/O**: 非阻塞I/O操作，提高并发性能
- **锁优化**: 使用读写锁和细粒度锁减少竞争

### 5.3 网络优化
- **连接复用**: 连接池减少连接建立开销
- **批量传输**: 大块数据传输减少网络往返
- **压缩传输**: 支持ZLIB压缩减少网络带宽

## 6. 错误处理和容错机制

### 6.1 异常处理
```cpp
class FileTransferException : public std::runtime_error {
public:
    explicit FileTransferException(const std::string& message) 
        : std::runtime_error(message) {}
};

class NetworkException : public FileTransferException {
public:
    explicit NetworkException(const std::string& message) 
        : FileTransferException("Network error: " + message) {}
};
```

### 6.2 重试机制
- **网络重试**: 连接失败自动重试
- **传输重试**: 传输失败支持断点续传
- **指数退避**: 重试间隔递增，避免网络风暴

### 6.3 日志系统
```cpp
enum class LogLevel {
    DEBUG,
    INFO,
    WARNING,
    ERROR
};

class Logger {
public:
    static void log(LogLevel level, const char* format, ...);
    static void set_level(LogLevel level);
};
```

## 7. 测试策略

### 7.1 单元测试
- **加密模块测试**: 验证DH密钥交换和AES加密
- **协议测试**: 验证消息编解码
- **工具类测试**: 验证各种工具函数

### 7.2 集成测试
- **端到端测试**: 完整的文件传输流程
- **并发测试**: 多客户端并发传输
- **压力测试**: 大文件和长时间传输

### 7.3 安全测试
- **加密测试**: 验证传输安全性
- **认证测试**: 验证用户权限控制
- **渗透测试**: 模拟各种攻击场景

## 8. 部署和运维

### 8.1 构建系统
- **CMake**: 跨平台构建系统
- **依赖管理**: 自动检测和配置依赖库
- **版本控制**: 支持不同OpenSSL版本

### 8.2 配置管理
```json
{
    "bind_address": "0.0.0.0",
    "port": 12345,
    "storage_path": "./storage",
    "max_connections": 100,
    "thread_pool_size": 4,
    "log_level": "info"
}
```

### 8.3 监控和日志
- **性能监控**: 连接数、传输速度、错误率
- **安全审计**: 用户登录、文件访问记录
- **系统日志**: 详细的运行日志和错误日志

## 9. 扩展性设计

### 9.1 插件架构
预留插件接口，支持功能扩展：
- **传输协议插件**: 支持FTP、SFTP等协议
- **存储后端插件**: 支持云存储、分布式存储
- **认证插件**: 支持LDAP、OAuth等认证方式

### 9.2 微服务架构
为大规模部署预留微服务拆分：
- **认证服务**: 独立的用户认证服务
- **存储服务**: 独立的文件存储服务
- **传输服务**: 独立的文件传输服务

## 10. 总结

### 10.1 技术亮点
1. **现代C++**: 充分利用C++17特性，代码简洁高效
2. **安全优先**: 采用最新的密码学标准，确保传输安全
3. **高性能**: 异步I/O、连接池、线程池等优化技术
4. **可扩展**: 模块化设计，支持功能扩展和微服务拆分

### 10.2 架构优势
1. **分层清晰**: 职责分离，便于维护和测试
2. **模块独立**: 各模块松耦合，可独立开发和部署
3. **标准兼容**: 使用标准协议和API，兼容性好
4. **生产就绪**: 完整的错误处理、日志、监控机制

### 10.3 适用场景
- **企业文件传输**: 安全的企业内部文件共享
- **云存储同步**: 本地与云存储之间的文件同步
- **备份系统**: 大文件的安全备份传输
- **开发工具**: 开发环境中的文件传输工具

### 10.4 面试重点
1. **技术深度**: 详细解释了每个技术选型的原因和实现细节
2. **架构思维**: 展示了从需求分析到架构设计的完整思路
3. **工程能力**: 体现了对性能、安全、可维护性的全面考虑
4. **现代C++**: 展示了C++17特性的实际应用
5. **安全设计**: 详细的安全机制设计体现了安全意识

这个架构设计体现了现代C++项目的最佳实践，结合了安全性、性能和可维护性的要求，是一个高质量的企业级文件传输解决方案。